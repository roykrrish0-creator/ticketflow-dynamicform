<div class="form-section-container">
  <mat-expansion-panel 
    [expanded]="!section.collapsed"
    class="section-panel">
    
    <!-- Section Header -->
    <mat-expansion-panel-header class="section-header">
      <mat-panel-title class="section-title">
        <mat-icon class="section-icon w-6 h-6">{{ getSectionIcon() }}</mat-icon>
        <span class="section-title-text">{{ section.title }}</span>
      </mat-panel-title>
    </mat-expansion-panel-header>

    <!-- Section Content -->
    <div class="section-content" [formGroup]="formGroup">
      <div class="form-grid">
        @for (field of section.fields; track trackByFieldId($index, field)) {
        <div 
          class="form-field-container"
          [class]="getFieldGridClass(field)">
          
          <!-- Text Input -->
          @if (field.type === 'text') {
          <mat-form-field class="form-field">
            <mat-label>{{ field.label }}</mat-label>
            <input 
              matInput 
              [formControlName]="field.id"
              [placeholder]="field.placeholder || ''"
              [readonly]="field.readOnly"
              [type]="getInputType(field)"
              [attr.autocomplete]="getFieldAttribute(field, 'autocomplete')">
            @if (field.attributes?.hint) {
            <mat-hint>{{ getFieldAttribute(field, 'hint') }}</mat-hint>
            }
            @if (hasFieldError(field.id, 'required')) {
            <mat-error>
              {{ getValidationMessage(field, 'required') }}
            </mat-error>
            }
            @if (hasFieldError(field.id, 'email')) {
            <mat-error>
              {{ getValidationMessage(field, 'email') }}
            </mat-error>
            }
            @if (hasFieldError(field.id, 'minlength')) {
            <mat-error>
              {{ getValidationMessage(field, 'minlength') }}
            </mat-error>
            }
            @if (hasFieldError(field.id, 'maxlength')) {
            <mat-error>
              {{ getValidationMessage(field, 'maxlength') }}
            </mat-error>
            }
            @if (hasFieldError(field.id, 'pattern')) {
            <mat-error>
              {{ getValidationMessage(field, 'pattern') }}
            </mat-error>
            }
          </mat-form-field>
          }

          <!-- Textarea -->
          @if (field.type === 'textarea') {
          <mat-form-field class="form-field full-width">
            <mat-label>{{ field.label }}</mat-label>
            <textarea 
              matInput 
              [formControlName]="field.id"
              [placeholder]="field.placeholder || ''"
              [rows]="field.attributes?.rows || 3"
              [readonly]="field.readOnly"
              [attr.maxlength]="getFieldAttribute(field, 'maxlength')">
            </textarea>
            @if (field.attributes?.hint) {
            <mat-hint>{{ getFieldAttribute(field, 'hint') }}</mat-hint>
            }
            @if (hasFieldError(field.id, 'required')) {
            <mat-error>
              {{ getValidationMessage(field, 'required') }}
            </mat-error>
            }
            @if (hasFieldError(field.id, 'minlength')) {
            <mat-error>
              {{ getValidationMessage(field, 'minlength') }}
            </mat-error>
            }
            @if (hasFieldError(field.id, 'maxlength')) {
            <mat-error>
              {{ getValidationMessage(field, 'maxlength') }}
            </mat-error>
            }
          </mat-form-field>
          }

          <!-- Select -->
          @if (field.type === 'select') {
          <mat-form-field class="form-field">
            <mat-label>{{ field.label }}</mat-label>
            <mat-select [formControlName]="field.id" [disabled]="isFieldDisabled(field)">
              @for (option of getFieldOptions(field); track trackByOptionValue($index, option)) {
              <mat-option 
                [value]="option.value"
                [disabled]="option.disabled">
                {{ option.label }}
              </mat-option>
              }
            </mat-select>
            @if (field.attributes?.hint) {
            <mat-hint>{{ getFieldAttribute(field, 'hint') }}</mat-hint>
            }
            @if (hasFieldError(field.id, 'required')) {
            <mat-error>
              {{ getValidationMessage(field, 'required') }}
            </mat-error>
            }
          </mat-form-field>
          }

          <!-- Radio Group -->
          @if (field.type === 'radio') {
          <div class="radio-group full-width">
            <label class="field-label">{{ field.label }}</label>
            <mat-radio-group 
              [formControlName]="field.id" 
              class="radio-group-content"
              [disabled]="isFieldDisabled(field)">
              @for (option of getFieldOptions(field); track trackByOptionValue($index, option)) {
              <mat-radio-button 
                [value]="option.value"
                [disabled]="option.disabled"
                class="radio-option">
                {{ option.label }}
              </mat-radio-button>
              }
            </mat-radio-group>
            @if (field.attributes?.hint) {
            <div class="field-hint">{{ getFieldAttribute(field, 'hint') }}</div>
            }
            @if (hasFieldError(field.id, 'required')) {
            <div class="field-error">
              {{ getValidationMessage(field, 'required') }}
            </div>
            }
          </div>
          }

          <!-- Number Input -->
          @if (field.type === 'number') {
          <mat-form-field class="form-field">
            <mat-label>{{ field.label }}</mat-label>
            <input 
              matInput 
              type="number"
              [formControlName]="field.id"
              [placeholder]="field.placeholder || ''"
              [readonly]="field.readOnly"
              [min]="getFieldAttribute(field, 'min')"
              [max]="getFieldAttribute(field, 'max')"
              [step]="getFieldAttribute(field, 'step')">
            @if (field.attributes?.hint) {
            <mat-hint>{{ getFieldAttribute(field, 'hint') }}</mat-hint>
            }
            @if (hasFieldError(field.id, 'required')) {
            <mat-error>
              {{ getValidationMessage(field, 'required') }}
            </mat-error>
            }
            @if (hasFieldError(field.id, 'min')) {
            <mat-error>
              {{ getValidationMessage(field, 'min') }}
            </mat-error>
            }
            @if (hasFieldError(field.id, 'max')) {
            <mat-error>
              {{ getValidationMessage(field, 'max') }}
            </mat-error>
            }
          </mat-form-field>
          }

          <!-- Date Input -->
          @if (field.type === 'date') {
          <mat-form-field 
            appearance="outline"
            class="form-field">
            <mat-label>{{ field.label }}</mat-label>
            <input 
              matInput 
              [matDatepicker]="picker"
              [formControlName]="field.id"
              [readonly]="field.readOnly"
              [min]="getFieldAttribute(field, 'min')"
              [max]="getFieldAttribute(field, 'max')">
            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            @if (field.attributes?.hint) {
            <mat-hint>{{ getFieldAttribute(field, 'hint') }}</mat-hint>
            }
            @if (hasFieldError(field.id, 'required')) {
            <mat-error>
              {{ getValidationMessage(field, 'required') }}
            </mat-error>
            }
            @if (hasFieldError(field.id, 'matDatepickerMin')) {
            <mat-error>
              Date must be after minimum allowed date
            </mat-error>
            }
            @if (hasFieldError(field.id, 'matDatepickerMax')) {
            <mat-error>
              Date must be before maximum allowed date
            </mat-error>
            }
          </mat-form-field>
          }

          <!-- Checkbox -->
          @if (field.type === 'checkbox') {
          <div class="checkbox-field">
            <mat-checkbox 
              [formControlName]="field.id" 
              [disabled]="isFieldDisabled(field)">
              {{ field.label }}
            </mat-checkbox>
            @if (field.attributes?.hint) {
            <div class="field-hint">{{ getFieldAttribute(field, 'hint') }}</div>
            }
          </div>
          }

        </div>
        }
      </div>
    </div>
  </mat-expansion-panel>
</div>
